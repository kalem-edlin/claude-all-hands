name: AllHands Sync

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - develop
      - staging
      - production

jobs:
  sync-back:
    runs-on: ubuntu-latest

    steps:
      - name: Check repository owner
        id: owner-check
        run: |
          UPSTREAM_OWNER="kalem-edlin"
          if [ "${{ github.repository_owner }}" = "$UPSTREAM_OWNER" ]; then
            echo "is_owner=true" >> $GITHUB_OUTPUT
            echo "âœ… Repository owner matches upstream ($UPSTREAM_OWNER)"
          else
            echo "is_owner=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Repository owner (${{ github.repository_owner }}) does not match upstream ($UPSTREAM_OWNER)"
            echo "Sync-back is only available for the upstream repository owner."
            echo ""
            echo "To contribute changes back to claude-all-hands:"
            echo "1. Fork https://github.com/kalem-edlin/claude-all-hands"
            echo "2. Create a branch with your changes"
            echo "3. Open a pull request manually"
          fi

      - name: Checkout
        if: steps.owner-check.outputs.is_owner == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.owner-check.outputs.is_owner == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run sync-back
        id: sync
        if: steps.owner-check.outputs.is_owner == 'true'
        env:
          GH_TOKEN: ${{ secrets.ALL_HANDS_SYNC_TOKEN }}
        run: |
          # Capture sync-back output
          OUTPUT=$(npx claude-all-hands sync-back --auto 2>&1) || true
          echo "$OUTPUT"

          # Extract PR URL if created
          PR_URL=$(echo "$OUTPUT" | grep -oE 'https://github.com/[^[:space:]]+/pull/[0-9]+' | head -1 || true)
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          # Check if sync happened
          if echo "$OUTPUT" | grep -q "No changes to sync"; then
            echo "synced=false" >> $GITHUB_OUTPUT
          else
            echo "synced=true" >> $GITHUB_OUTPUT
          fi

      - name: Find associated PR
        id: find-pr
        if: steps.owner-check.outputs.is_owner == 'true' && steps.sync.outputs.synced == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find PR that was merged with this commit
          PR_NUMBER=$(gh pr list --state merged --search "${{ github.sha }}" --json number --jq '.[0].number' 2>/dev/null || true)
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.owner-check.outputs.is_owner == 'true' && steps.sync.outputs.synced == 'true' && steps.find-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.find-pr.outputs.pr_number }}"
          SYNC_PR_URL="${{ steps.sync.outputs.pr_url }}"

          if [ -n "$SYNC_PR_URL" ]; then
            gh pr comment "$PR_NUMBER" --body "ðŸ”„ **AllHands Sync**: Changes synced to upstream! PR: $SYNC_PR_URL"
          else
            gh pr comment "$PR_NUMBER" --body "ðŸ”„ **AllHands Sync**: Sync completed (PR may already exist)"
          fi
