#!/bin/bash
# claude-envoy: CLI for agent-scoped external tool access (TypeScript)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Load .env if exists
if [ -f "$PROJECT_DIR/.env" ]; then
    set -a
    . "$PROJECT_DIR/.env"
    set +a
fi

# Auto-install if node_modules missing
if [ ! -d "$SCRIPT_DIR/node_modules" ]; then
    echo "Installing envoy dependencies..." >&2
    if ! npm install --prefix "$SCRIPT_DIR" --legacy-peer-deps; then
        echo "ERROR: npm install failed for claude-envoy" >&2
        exit 1
    fi
    cp "$SCRIPT_DIR/package.json" "$SCRIPT_DIR/node_modules/.package.json.cache" 2>/dev/null
fi

# Reinstall if package.json changed
if ! cmp -s "$SCRIPT_DIR/package.json" "$SCRIPT_DIR/node_modules/.package.json.cache" 2>/dev/null; then
    echo "Updating envoy dependencies..." >&2
    if ! npm install --prefix "$SCRIPT_DIR" --legacy-peer-deps; then
        echo "ERROR: npm install failed for claude-envoy" >&2
        exit 1
    fi
    cp "$SCRIPT_DIR/package.json" "$SCRIPT_DIR/node_modules/.package.json.cache" 2>/dev/null
fi

# Use tsx for direct TypeScript execution (no compile step needed)
exec "$SCRIPT_DIR/node_modules/.bin/tsx" "$SCRIPT_DIR/src/cli.ts" "$@"
