#!/bin/bash
# claude-envoy: CLI for agent-scoped external tool access

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"

# Load .env if exists
if [ -f "$PROJECT_DIR/.env" ]; then
    set -a
    . "$PROJECT_DIR/.env"
    set +a
fi

# Auto-create venv if missing
if [ ! -d "$VENV_DIR" ]; then
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip" install -q -r "$SCRIPT_DIR/requirements.txt"
    cp "$SCRIPT_DIR/requirements.txt" "$VENV_DIR/.requirements.txt"
fi

# Reinstall if requirements.txt changed
if ! cmp -s "$SCRIPT_DIR/requirements.txt" "$VENV_DIR/.requirements.txt" 2>/dev/null; then
    "$VENV_DIR/bin/pip" install -q -r "$SCRIPT_DIR/requirements.txt"
    cp "$SCRIPT_DIR/requirements.txt" "$VENV_DIR/.requirements.txt"
fi

# Suppress Python warnings (urllib3, deprecation, etc)
export PYTHONWARNINGS="ignore"
exec "$VENV_DIR/bin/python" "$SCRIPT_DIR/envoy.py" "$@"
